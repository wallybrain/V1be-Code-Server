auth.{$DOMAIN} {
	handle /custom-auth.css {
		root * /srv/authelia-theme
		file_server
	}
	handle /autofill-fix.js {
		root * /srv/authelia-theme
		file_server
	}
	handle {
		reverse_proxy authelia:9091 {
			header_up Accept-Encoding identity
		}
		replace </head> "<link rel='stylesheet' href='/custom-auth.css'><script src='/autofill-fix.js'></script></head>"
	}
}

auth.wallybrain.icu {
	handle /custom-auth.css {
		root * /srv/authelia-theme
		file_server
	}
	handle /autofill-fix.js {
		root * /srv/authelia-theme
		file_server
	}
	handle {
		reverse_proxy authelia:9091 {
			header_up Accept-Encoding identity
		}
		replace </head> "<link rel='stylesheet' href='/custom-auth.css'><script src='/autofill-fix.js'></script></head>"
	}
}

ollama.{$DOMAIN} {
	@unauthorized not header Authorization "Bearer {$OLLAMA_API_KEY}"
	respond @unauthorized 403

	reverse_proxy host.docker.internal:11434
}

code.{$DOMAIN} {
	forward_auth authelia:9091 {
		uri /api/authz/forward-auth
		copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
	}
	reverse_proxy host.docker.internal:8080
}

wallybrain.icu {
	header {
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Admin routes: require Authelia 2FA
	@admin path /admin /admin/*
	handle @admin {
		forward_auth authelia:9091 {
			uri /api/authz/forward-auth
			copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
		}
		reverse_proxy wallybrain-music:8800
	}

	# Everything else: public music site
	handle {
		reverse_proxy wallybrain-music:8800
	}
}

{$DOMAIN} {
	header {
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Block sensitive paths before any file serving
	handle /.git/* {
		respond 404
	}
	handle /.git {
		respond 404
	}

	# Redirect old /music paths to new domain
	handle /music {
		redir https://wallybrain.icu/ permanent
	}
	handle_path /music/* {
		redir https://wallybrain.icu{uri} permanent
	}

	# Everything else: serve static Semantic Training site
	handle {
		root * /srv/semantic-training
		file_server
	}
}
