auth.{$DOMAIN} {
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
	}

	handle /custom-auth.css {
		root * /srv/authelia-theme
		file_server
	}
	handle /autofill-fix.js {
		root * /srv/authelia-theme
		file_server
	}
	handle {
		reverse_proxy authelia:9091 {
			header_up Accept-Encoding identity
		}
		replace </head> "<link rel='stylesheet' href='/custom-auth.css'><script src='/autofill-fix.js'></script></head>"
	}
}

auth.wallybrain.icu {
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
	}

	handle /custom-auth.css {
		root * /srv/authelia-theme
		file_server
	}
	handle /autofill-fix.js {
		root * /srv/authelia-theme
		file_server
	}
	handle {
		reverse_proxy authelia:9091 {
			header_up Accept-Encoding identity
		}
		replace </head> "<link rel='stylesheet' href='/custom-auth.css'><script src='/autofill-fix.js'></script></head>"
	}
}

ollama.{$DOMAIN} {
	@unauthorized not header Authorization "Bearer {$OLLAMA_API_KEY}"
	respond @unauthorized 403

	reverse_proxy host.docker.internal:11434
}

code.{$DOMAIN} {
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
	}

	forward_auth authelia:9091 {
		uri /api/authz/forward-auth
		copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
	}
	reverse_proxy host.docker.internal:8080
}

play.wallybrain.icu {
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		Referrer-Policy strict-origin-when-cross-origin
		Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval' blob:; style-src 'self' 'unsafe-inline'; worker-src 'self' blob:; connect-src 'self' blob:; img-src 'self' data: blob:"
	}
	reverse_proxy zork:8080
}

solitaire.wallybrain.icu {
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		Referrer-Policy strict-origin-when-cross-origin
		Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
	}
	reverse_proxy solitaire:8080
}

wallybrain.icu {
	request_body {
		max_size 1GB
	}

	header {
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
	}

	# Admin routes: require Authelia 2FA
	# Strip headers that Authelia also sets to avoid duplicates
	@admin path /admin /admin/*
	handle @admin {
		header -X-Frame-Options
		header -X-Content-Type-Options
		header -Referrer-Policy
		header -Permissions-Policy
		header -Content-Security-Policy
		forward_auth authelia:9091 {
			uri /api/authz/forward-auth
			copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
		}
		reverse_proxy wallybrain-music:8800
	}

	# Everything else: public music site
	handle {
		reverse_proxy wallybrain-music:8800
	}
}

{$DOMAIN} {
	header {
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		Referrer-Policy "strict-origin-when-cross-origin"
		Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; font-src 'self'; img-src 'self' data:; connect-src 'self'; frame-ancestors 'self'"
		Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
	}

	# Block sensitive paths before any file serving
	handle /.git/* {
		respond 404
	}
	handle /.git {
		respond 404
	}

	# Redirect old /music paths to new domain
	handle /music {
		redir https://wallybrain.icu/ permanent
	}
	handle_path /music/* {
		redir https://wallybrain.icu{uri} permanent
	}

	# Everything else: serve static Semantic Training site
	handle {
		root * /srv/semantic-training
		file_server
	}
}
