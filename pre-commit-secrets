#!/usr/bin/env bash
#
# Global pre-commit hook: blocks commits containing secrets.
# Installed at: ~/.git-hooks/pre-commit
# Activated by: git config --global core.hooksPath ~/.git-hooks
#
# To bypass in an emergency: git commit --no-verify
# (but you should almost never need this)

set -euo pipefail

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

BLOCKED=0

# --- 1. Block sensitive filenames ---
BLOCKED_FILES_PATTERN='(^|/)\.env$|(^|/)\.env\.[^e]|users_database\.yml|notification\.txt|\.pem$|\.key$|id_rsa|id_ed25519|settings\.json'

staged_files=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

while IFS= read -r file; do
    [ -z "$file" ] && continue
    if echo "$file" | grep -qEi "$BLOCKED_FILES_PATTERN"; then
        # Allow .env.example
        if echo "$file" | grep -q '\.env\.example$'; then
            continue
        fi
        echo -e "${RED}BLOCKED${NC}: Sensitive file staged: ${YELLOW}${file}${NC}"
        BLOCKED=1
    fi
done <<< "$staged_files"

# --- 2. Scan staged diff for secret patterns ---
SECRET_PATTERNS=(
    # Explicit secret assignments (key=value or key: value with actual secrets)
    '["\x27]?[A-Za-z_]*(SECRET|PASSWORD|TOKEN|API_KEY|ENCRYPTION_KEY|JWT_SECRET|PRIVATE_KEY)["\x27]?\s*[:=]\s*["\x27][^"\x27$]{8,}'
    # Argon2 / bcrypt hashes
    '\$argon2(i|id|d)\$'
    '\$2[aby]\$[0-9]{2}\$'
    # AWS keys
    'AKIA[0-9A-Z]{16}'
    # Long hex strings that look like secrets (64+ chars, likely API keys)
    '[:=]\s*["\x27][0-9a-f]{64,}["\x27]'
    # Bearer tokens in code
    'Bearer\s+[A-Za-z0-9_\-\.]{20,}'
)

diff_content=$(git diff --cached -U0 2>/dev/null || true)

for pattern in "${SECRET_PATTERNS[@]}"; do
    matches=$(echo "$diff_content" | grep -nEi "^\+" | grep -Ei "$pattern" 2>/dev/null || true)
    if [ -n "$matches" ]; then
        echo -e "${RED}BLOCKED${NC}: Potential secret detected in staged changes:"
        echo "$matches" | head -5 | while IFS= read -r line; do
            # Truncate long lines to avoid dumping the actual secret
            echo -e "  ${YELLOW}${line:0:120}${NC}"
        done
        BLOCKED=1
    fi
done

# --- 3. Verdict ---
if [ "$BLOCKED" -eq 1 ]; then
    echo ""
    echo -e "${RED}Commit blocked by pre-commit secret scanner.${NC}"
    echo "If this is a false positive, use: git commit --no-verify"
    echo "If real, remove the secret and use .env + env var injection instead."
    exit 1
fi
